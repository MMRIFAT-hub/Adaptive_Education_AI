<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Faculty Dashboard</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* Additional styles for new analytics */
    .analytics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .analytics-card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      border-left: 4px solid #4CAF50;
    }
    
    .analytics-card h3 {
      margin-top: 0;
      color: #333;
      font-size: 1.1em;
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
    }
    
    .stat-value {
      font-size: 2em;
      font-weight: bold;
      color: #2c3e50;
      margin: 10px 0;
    }
    
    .stat-label {
      color: #7f8c8d;
      font-size: 0.9em;
    }
    
    .progress-container {
      background: #ecf0f1;
      border-radius: 10px;
      height: 20px;
      margin: 10px 0;
      overflow: hidden;
    }
    
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #3498db, #2ecc71);
      border-radius: 10px;
      transition: width 0.5s ease;
    }
    
    .topic-breakdown {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-top: 15px;
    }
    
    .topic-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px;
      background: #f8f9fa;
      border-radius: 5px;
    }
    
    .topic-score {
      font-weight: bold;
      color: #2c3e50;
    }
    
    .level-distribution {
      display: flex;
      justify-content: space-between;
      margin-top: 15px;
    }
    
    .level-item {
      text-align: center;
      flex: 1;
      padding: 10px;
    }
    
    .level-count {
      font-size: 1.5em;
      font-weight: bold;
      color: #3498db;
    }
    
    .level-label {
      font-size: 0.8em;
      color: #7f8c8d;
    }
    
    .risk-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 8px;
    }
    
    .risk-high { background: #e74c3c; }
    .risk-medium { background: #f39c12; }
    .risk-low { background: #2ecc71; }
    
    .student-list {
      max-height: 200px;
      overflow-y: auto;
      margin-top: 10px;
    }
    
    .student-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px;
      border-bottom: 1px solid #ecf0f1;
    }
  </style>
</head>
<body>

  <header>
    <nav>
      <ul class="nav-bar">
        <li class="logo"><a href="index.html">EDGo Logo</a></li>
        <div class="center-links">
          <h1 class="glow-title">Faculty Dashboard - Enhanced Analytics</h1>
        </div>
      </ul>
      <a href="index.html" class="home" title="Home"></a>
      <a href="personalInfo.html" class="profile-icon" title="Profile"></a>
    </nav>
  </header>

  <section class="features">
    <!-- New Analytics Section -->
    <div class="analytics-grid" id="analytics-grid">
      <!-- Analytics will be populated by JavaScript -->
    </div>

    <section class="performance-data">
      <div class="summary-cards">
        <div class="card">
          <h4>Average Midterm Score</h4>
          <p><span class="highlight" id="average-score">Loading...</span></p>
        </div>
        <div class="card">
          <h4>Total Retakes Remaining</h4>
          <p><span class="highlight">9</span></p>
        </div>
      </div>

      <table class="performance-table">
        <thead>
          <tr>
            <th>Student ID</th>
            <th>Name</th>
            <th>Midterm Score</th>
            <th>Current Level</th>
            <th>Retake Date</th>
          </tr>
        </thead>
        <tbody>
          <!-- Dynamic rows will be inserted here from Firebase -->
        </tbody>
      </table>
    </section>

    <button id="toggle-sidebar" class="sidebar-toggle"></button>

    <div id="sidebar" class="sidebar">
      <ul>
        <li><a href="#">Student Performance</a></li>
        <li><a href="retakeFaculty.html">Retake Request</a></li>
        <li><a href="addStudent.html">Add Student</a></li>
        <li><a href="grading.html">Feedback and Messaging</a></li>
        <li><a href="#">AI Assesment</a></li>
        <li><a href="#">Settings</a></li>
      </ul>
    </div>
  </section>

  <section class="lower">
    <h2>Explore More Features</h2>
    <p>Our AI assistant helps with quizzes and grading!</p>
  </section>

  <footer>
    Dhaka, Bangladesh
  </footer>
  <!-- Logout Button -->
  <button id="logout-button" class="logout-button">Logout</button>
  <button class="learn-more">Click here to learn more</button>

  <!-- Use "type=module" to use ES modules (import/export) -->
  <script type="module">
    // Import necessary Firebase functions
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";

    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyD63qm0V0F0Y0PExzmmOCP9nJ7a6x1vCgs",
      authDomain: "edora2.firebaseapp.com",
      projectId: "edora2",
      storageBucket: "edora2.firebasestorage.app",
      messagingSenderId: "908106047332",
      appId: "1:908106047332:web:4b412cd208e88fceb06471",
      measurementId: "G-ELBKQDSSKC",
      databaseURL: "https://edora2-default-rtdb.asia-southeast1.firebasedatabase.app"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    const auth = getAuth();

    // Enhanced analytics functions
    function calculateAnalytics(students) {
      const analytics = {
        totalStudents: 0,
        averageMidtermScore: 0,
        averageOverallPercentage: 0,
        levelCompletion: { level1: 0, level2: 0, level3: 0 },
        topicPerformance: {},
        atRiskStudents: [],
        topPerformers: [],
        retakeEligibility: 0
      };

      let totalMidtermScore = 0;
      let totalOverallPercentage = 0;
      let studentCount = 0;

      for (const studentId in students) {
        const student = students[studentId];
        studentCount++;

        // Midterm score
        totalMidtermScore += student.midtermScore || 0;
        
        // Overall percentage
        totalOverallPercentage += student.percentage || 0;

        // Level completion
        if (student.completedLevels) {
          if (student.completedLevels[0]) analytics.levelCompletion.level1++;
          if (student.completedLevels[1]) analytics.levelCompletion.level2++;
          if (student.completedLevels[2]) analytics.levelCompletion.level3++;
        }

        // Topic performance
        if (student.topic_scores) {
          for (const topic in student.topic_scores) {
            if (!analytics.topicPerformance[topic]) {
              analytics.topicPerformance[topic] = {
                total: 0,
                count: 0,
                average: 0
              };
            }
            analytics.topicPerformance[topic].total += student.topic_scores[topic];
            analytics.topicPerformance[topic].count++;
          }
        }

        // Identify at-risk students (midterm score < 40 or overall percentage < 50)
        if ((student.midtermScore < 40 || student.percentage < 50) && student.name) {
          analytics.atRiskStudents.push({
            name: student.name,
            midtermScore: student.midtermScore,
            percentage: student.percentage,
            riskLevel: student.midtermScore < 30 ? 'high' : student.midtermScore < 40 ? 'medium' : 'low'
          });
        }

        // Identify top performers (overall percentage > 80)
        if (student.percentage > 80 && student.name) {
          analytics.topPerformers.push({
            name: student.name,
            percentage: student.percentage,
            completedLevels: student.completedLevels ? student.completedLevels.filter(Boolean).length : 0
          });
        }

        // Retake eligibility
        if (student.retakeDaysLeft > 0) {
          analytics.retakeEligibility++;
        }
      }

      // Calculate averages
      analytics.totalStudents = studentCount;
      analytics.averageMidtermScore = studentCount > 0 ? totalMidtermScore / studentCount : 0;
      analytics.averageOverallPercentage = studentCount > 0 ? totalOverallPercentage / studentCount : 0;

      // Calculate topic averages
      for (const topic in analytics.topicPerformance) {
        const topicData = analytics.topicPerformance[topic];
        topicData.average = topicData.count > 0 ? topicData.total / topicData.count : 0;
      }

      // Sort at-risk students by risk level
      analytics.atRiskStudents.sort((a, b) => {
        const riskOrder = { high: 0, medium: 1, low: 2 };
        return riskOrder[a.riskLevel] - riskOrder[b.riskLevel];
      });

      // Sort top performers by percentage
      analytics.topPerformers.sort((a, b) => b.percentage - a.percentage);

      return analytics;
    }

    function renderAnalytics(analytics) {
      const analyticsGrid = document.getElementById('analytics-grid');
      
      analyticsGrid.innerHTML = `
        <!-- Overall Performance Card -->
        <div class="analytics-card">
          <h3>Overall Class Performance</h3>
          <div class="stat-value">${analytics.averageOverallPercentage.toFixed(1)}%</div>
          <div class="stat-label">Average Overall Score</div>
          <div class="progress-container">
            <div class="progress-bar" style="width: ${analytics.averageOverallPercentage}%"></div>
          </div>
          <div style="display: flex; justify-content: space-between; margin-top: 10px;">
            <div>
              <div class="stat-value">${analytics.averageMidtermScore.toFixed(1)}</div>
              <div class="stat-label">Avg Midterm</div>
            </div>
            <div>
              <div class="stat-value">${analytics.totalStudents}</div>
              <div class="stat-label">Total Students</div>
            </div>
          </div>
        </div>

        <!-- Level Completion Card -->
        <div class="analytics-card">
          <h3>Level Completion Progress</h3>
          <div class="level-distribution">
            <div class="level-item">
              <div class="level-count">${analytics.levelCompletion.level1}</div>
              <div class="level-label">Level 1</div>
              <div class="progress-container" style="height: 8px; margin: 5px 0;">
                <div class="progress-bar" style="width: ${(analytics.levelCompletion.level1 / analytics.totalStudents) * 100}%; background: #3498db;"></div>
              </div>
            </div>
            <div class="level-item">
              <div class="level-count">${analytics.levelCompletion.level2}</div>
              <div class="level-label">Level 2</div>
              <div class="progress-container" style="height: 8px; margin: 5px 0;">
                <div class="progress-bar" style="width: ${(analytics.levelCompletion.level2 / analytics.totalStudents) * 100}%; background: #9b59b6;"></div>
              </div>
            </div>
            <div class="level-item">
              <div class="level-count">${analytics.levelCompletion.level3}</div>
              <div class="level-label">Level 3</div>
              <div class="progress-container" style="height: 8px; margin: 5px 0;">
                <div class="progress-bar" style="width: ${(analytics.levelCompletion.level3 / analytics.totalStudents) * 100}%; background: #2ecc71;"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Topic Performance Card -->
        <div class="analytics-card">
          <h3>Topic Performance Analysis</h3>
          <div class="topic-breakdown">
            ${Object.entries(analytics.topicPerformance).map(([topic, data]) => `
              <div class="topic-item">
                <span>${topic.replace('_label', '').replace(/([A-Z])/g, ' $1').trim()}</span>
                <span class="topic-score">${data.average.toFixed(0)}%</span>
              </div>
            `).join('')}
          </div>
        </div>

        <!-- At-Risk Students Card -->
        <div class="analytics-card">
          <h3>Students Needing Attention</h3>
          <div class="stat-value">${analytics.atRiskStudents.length}</div>
          <div class="stat-label">At-Risk Students</div>
          <div class="student-list">
            ${analytics.atRiskStudents.slice(0, 5).map(student => `
              <div class="student-item">
                <span>
                  <span class="risk-indicator risk-${student.riskLevel}"></span>
                  ${student.name}
                </span>
                <span>${student.midtermScore}/60</span>
              </div>
            `).join('')}
            ${analytics.atRiskStudents.length > 5 ? `<div style="text-align: center; color: #7f8c8d; margin-top: 10px;">+${analytics.atRiskStudents.length - 5} more</div>` : ''}
          </div>
        </div>

        <!-- Top Performers Card -->
        <div class="analytics-card">
          <h3>Top Performers</h3>
          <div class="student-list">
            ${analytics.topPerformers.slice(0, 5).map(student => `
              <div class="student-item">
                <span>${student.name}</span>
                <span style="color: #2ecc71; font-weight: bold;">${student.percentage.toFixed(1)}%</span>
              </div>
            `).join('')}
          </div>
        </div>

        <!-- Retake Analytics Card -->
        <div class="analytics-card">
          <h3>Retake Management</h3>
          <div class="stat-value">${analytics.retakeEligibility}</div>
          <div class="stat-label">Eligible for Retake</div>
          <div style="margin-top: 15px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
              <span>Available Retakes:</span>
              <span style="font-weight: bold;">9</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span>Utilized:</span>
              <span style="font-weight: bold;">${analytics.totalStudents - analytics.retakeEligibility}</span>
            </div>
          </div>
        </div>
      `;
    }

    // Fetch student data from Firebase Realtime Database
    window.onload = function() {
      onAuthStateChanged(auth, function(user) {
        if (user) {
          const teacherId = user.uid; // Get the teacher's UID
          
          const studentsRef = ref(database, `teachers/${teacherId}/students`);
          get(studentsRef)
            .then((snapshot) => {
              if (snapshot.exists()) {
                const students = snapshot.val();
                const tableBody = document.querySelector('.performance-table tbody');
                const averageScoreElement = document.getElementById('average-score');
                
                let totalPercentage = 0;
                let studentCount = 0;

                tableBody.innerHTML = ''; // Clear previous rows

                for (const studentId in students) {
                  const student = students[studentId];

                  // Calculate percentage for individual student
                  const percentage = (student.midtermScore / student.totalScore) * 100;
                  totalPercentage += percentage;
                  studentCount++;

                  const tr = document.createElement('tr');
                  tr.innerHTML = `
                    <td>${studentId}</td>
                    <td>${student.name}</td>
                    <td>${percentage.toFixed(2)}%</td>
                    <td>Completed ${student.completedLevels.filter(level => level === true).length} out of 3 Levels</td>
                    <td>${new Date(student.retakeDate).toLocaleString()}</td>
                  `;
                  tableBody.appendChild(tr);
                }

                // Calculate and display the average percentage
                if (studentCount > 0) {
                  const averagePercentage = totalPercentage / studentCount;
                  averageScoreElement.textContent = `${averagePercentage.toFixed(2)}%`;
                  
                  // Calculate and render enhanced analytics
                  const analytics = calculateAnalytics(students);
                  renderAnalytics(analytics);
                } else {
                  averageScoreElement.textContent = 'No students available';
                }

              } else {
                console.log("No data available");
                document.getElementById('average-score').textContent = 'No data available';
              }
            })
            .catch((error) => {
              console.error("Error fetching data from Firebase:", error);
              document.getElementById('average-score').textContent = 'Error fetching data';
            });
        } else {
          // If no user is logged in, redirect to login
          window.location.href = 'login.html';
        }
      });
    };
  </script>

  <script>
    // Toggle sidebar visibility
    document.getElementById('toggle-sidebar').addEventListener('click', () => {
      const sidebar = document.getElementById('sidebar');
      sidebar.classList.toggle('active'); // Toggle the "active" class
    });

    // Logout functionality
    const logoutButton = document.getElementById("logout-button");
    logoutButton.addEventListener("click", () => {
      signOut(auth)
        .then(() => {
          window.location.href = "index.html"; // Redirect to login page after logout
        })
        .catch((error) => {
          console.error("Error signing out: ", error);
        });
    });
  </script>

</body>
</html>