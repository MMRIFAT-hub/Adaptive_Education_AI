<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Java OOP Quiz with Firebase</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Your existing CSS styles remain exactly the same */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body {
            background: linear-gradient(135deg, #1a2a6c, #000000, #1a2a6c);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        header {
            text-align: center;
            padding: 20px 0;
            margin-bottom: 30px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            width: 100%;
            max-width: 1000px;
            animation: fadeIn 1s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        header h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            text-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
            background: linear-gradient(to right, #d2cbcb, #e4e0f0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: glow 2s ease-in-out infinite alternate;
        }
        @keyframes glow {
            from {
                text-shadow: 0 0 10px #fff, 0 0 20px #fff, 0 0 30px #2906a7, 0 0 40px #7764f0;
            }
            to {
                text-shadow: 0 0 15px #fff, 0 0 25px #fff, 0 0 35px #ff5e62, 0 0 45px #ff5e62;
            }
        }
        header p {
            font-size: 1.2rem;
            max-width: 800px;
            margin: 0 auto;
            opacity: 0.9;
        }
        #quiz-container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            width: 100%;
            animation: slideIn 0.8s ease-out;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .level-selection {
            display: flex;
            justify-content: center;
            padding: 25px 20px;
            background: rgba(0, 0, 0, 0.3);
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }
        .level-button {
            padding: 15px 30px;
            margin: 0 10px;
            background: linear-gradient(45deg, #3498db, #1a5276);
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
        }
        .level-button i {
            margin-right: 8px;
            font-size: 1.2rem;
        }
        .level-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
            background: linear-gradient(45deg, #1a5276, #3498db);
        }
        .level-button:disabled {
            background: linear-gradient(45deg, #555, #333);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            opacity: 0.7;
        }
        .level-button.active {
            background: linear-gradient(45deg, #2ecc71, #27ae60);
            box-shadow: 0 0 15px rgba(46, 204, 113, 0.5);
        }
        .question-container {
            padding: 30px;
        }
        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }
        .question-header h2 {
            font-size: 1.8rem;
            color: #3498db;
        }
        .difficulty {
            background: #e74c3c;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
        }
        .question {
            font-size: 1.3rem;
            margin-bottom: 25px;
            line-height: 1.6;
            background: rgba(0, 0, 0, 0.2);
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #3498db;
        }
        .options {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }
        .option {
            padding: 15px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            border: 2px solid transparent;
        }
        .option:hover {
            background: rgba(52, 152, 219, 0.2);
            transform: translateX(5px);
        }
        .option.selected {
            background: rgba(46, 204, 113, 0.2);
            border-color: #2ecc71;
        }
        .option.correct {
            background: rgba(46, 204, 113, 0.3);
            border-color: #2ecc71;
            animation: pulse 1.5s infinite;
        }
        .option.incorrect {
            background: rgba(231, 76, 60, 0.3);
            border-color: #e74c3c;
        }
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.4);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(46, 204, 113, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(46, 204, 113, 0);
            }
        }
        .option input {
            margin-right: 15px;
            transform: scale(1.3);
        }
        .quiz-controls {
            display: flex;
            justify-content: space-between;
            padding: 20px 30px;
            background: rgba(0, 0, 0, 0.3);
            border-top: 2px solid rgba(255, 255, 255, 0.1);
        }
        #submit-button, #next-button {
            padding: 15px 40px;
            background: linear-gradient(45deg, #9b59b6, #8e44ad);
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        #submit-button:hover, #next-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
            background: linear-gradient(45deg, #8e44ad, #9b59b6);
        }
        #next-button {
            display: none;
            background: linear-gradient(45deg, #2ecc71, #27ae60);
        }
        #next-button:hover {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
        }
        .result-container {
            text-align: center;
            padding: 30px;
            display: none;
        }
        .result-container h3 {
            font-size: 2rem;
            margin-bottom: 20px;
            color: #f1c40f;
        }
        .score-display {
            font-size: 4rem;
            font-weight: bold;
            color: #2ecc71;
            margin: 20px 0;
            text-shadow: 0 0 10px rgba(46, 204, 113, 0.5);
        }
        .progress-container {
            width: 100%;
            height: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            margin: 25px 0;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #2ecc71, #3498db);
            border-radius: 10px;
            transition: width 0.5s ease;
        }
        .level-status {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }
        .level-status div {
            text-align: center;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            flex: 1;
            margin: 0 10px;
            transition: all 0.3s ease;
        }
        .level-status div.completed {
            background: rgba(46, 204, 113, 0.2);
            border: 2px solid #2ecc71;
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(46, 204, 113, 0.3);
        }
        .level-status div i {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: #2ecc71;
        }
        .feedback {
            padding: 15px;
            margin: 20px 0;
            border-radius: 10px;
            font-weight: bold;
            display: none;
            animation: fadeIn 0.5s ease;
        }
        .feedback.correct {
            background: rgba(46, 204, 113, 0.2);
            border: 2px solid #2ecc71;
            color: #2ecc71;
        }
        .feedback.incorrect {
            background: rgba(231, 76, 60, 0.2);
            border: 2px solid #e74c3c;
            color: #e74c3c;
        }
        .loading {
            text-align: center;
            padding: 30px;
        }
        .loader {
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 5px solid #3498db;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .user-info {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px 25px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            max-width: 800px;
            width: 100%;
        }
        .database-panel {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            max-width: 800px;
            width: 100%;
        }
        .database-content {
            display: flex;
            justify-content: space-between;
            margin: 15px 0;
        }
        .database-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            flex: 1;
            margin: 0 5px;
        }
        .status {
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: bold;
            margin-top: 10px;
        }
        .status.completed {
            background: rgba(46, 204, 113, 0.3);
            color: #2ecc71;
        }
        .status.not-completed {
            background: rgba(231, 76, 60, 0.3);
            color: #e74c3c;
        }
        .database-sync {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 10px;
        }
        .sync-indicator {
            width: 10px;
            height: 10px;
            background: #2ecc71;
            border-radius: 50%;
            margin-right: 10px;
            animation: pulse 2s infinite;
        }
        .api-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 15px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            font-size: 0.9rem;
        }
        .api-status.connected .status-indicator {
            background: #2ecc71;
        }
        .api-status.disconnected .status-indicator {
            background: #e74c3c;
        }
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .error-message {
            background: rgba(231, 76, 60, 0.3);
            border: 2px solid #e74c3c;
            color: #e74c3c;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }
        .retake-button {
            background: linear-gradient(45deg, #e67e22, #d35400);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.3s ease;
        }
        .retake-button:hover {
            background: linear-gradient(45deg, #d35400, #e67e22);
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <header>
        <h1><i class="fas fa-graduation-cap"></i> Personalized Quiz</h1>
        <p>Test your knowledge</p>
    </header>
    
    <div class="user-info" id="user-info">
        <p>Welcome, <span id="user-name">Student</span>!</p>
        <p>Status: <span id="user-status">Loading Firebase data...</span></p>
    </div>
    
    <div id="quiz-container">
        <div class="level-selection">
            <button class="level-button active" id="level-1" onclick="loadQuestions('Level 1', true)">
                <i class="fas fa-lock-open"></i> Level 1: Beginner
            </button>
            <button class="level-button" id="level-2" onclick="loadQuestions('Level 2', true)" disabled>
                <i class="fas fa-lock"></i> Level 2: Intermediate
            </button>
            <button class="level-button" id="level-3" onclick="loadQuestions('Level 3', true)" disabled>
                <i class="fas fa-lock"></i> Level 3: Advanced
            </button>
        </div>
        
        <div class="loading" id="loading-container">
            <div class="loader"></div>
            <p id="loading-text">Loading your progress from Firebase...</p>
        </div>
        
        <div class="question-container" id="question-container" style="display:none;">
            <div class="question-header">
                <h2>Question <span id="question-number">1</span> of <span id="total-questions">3</span></h2>
                <div class="difficulty">Level 1: Beginner</div>
            </div>
            
            <div class="question" id="question-text">
                Loading question...
            </div>
            
            <div class="feedback" id="feedback"></div>
            
            <div class="options" id="options-container">
                <!-- Options will be loaded here -->
            </div>
        </div>
        
        <div class="quiz-controls">
            <button id="submit-button" onclick="checkAnswer()">Submit Answer</button>
            <button id="next-button" onclick="loadNextQuestion()">Next Question <i class="fas fa-arrow-right"></i></button>
        </div>
        
        <div class="result-container" id="result-container">
            <h3>Quiz Completed!</h3>
            <div class="score-display" id="final-score">0%</div>
            <p id="result-message">Great job! You've mastered this level.</p>
            
            <div class="progress-container">
                <div class="progress-bar" id="progress-bar" style="width: 0%"></div>
            </div>
            
            <button class="retake-button" onclick="retakeLevel()">
                <i class="fas fa-redo"></i> Retake This Level
            </button>
            
            <div class="level-status">
                <div id="level1-status">
                    <i class="fas fa-lock"></i>
                    <h4>Level 1</h4>
                    <p>Locked</p>
                </div>
                <div id="level2-status">
                    <i class="fas fa-lock"></i>
                    <h4>Level 2</h4>
                    <p>Locked</p>
                </div>
                <div id="level3-status">
                    <i class="fas fa-lock"></i>
                    <h4>Level 3</h4>
                    <p>Locked</p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="database-panel">
        <h3><i class="fas fa-database"></i> Firebase Level Completion Status</h3>
        <div class="database-content">
            <div class="database-card" id="db-card-1">
                <h4><i class="fas fa-layer-group"></i> Level 1</h4>
                <div id="db-level1" class="status not-completed">Not Completed</div>
            </div>
            <div class="database-card" id="db-card-2">
                <h4><i class="fas fa-layer-group"></i> Level 2</h4>
                <div id="db-level2" class="status not-completed">Not Completed</div>
            </div>
            <div class="database-card" id="db-card-3">
                <h4><i class="fas fa-layer-group"></i> Level 3</h4>
                <div id="db-level3" class="status not-completed">Not Completed</div>
            </div>
        </div>
        <div class="database-sync">
            <div class="sync-indicator"></div>
            <span>Firebase Realtime Sync Active</span>
        </div>
    </div>
    
    <div class="api-status connected" id="api-status">
        <div class="status-indicator"></div>
        <span>Backend API Connected</span>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD63qm0V0F0Y0PExzmmOCP9nJ7a6x1vCgs",
            authDomain: "edora2.firebaseapp.com",
            databaseURL: "https://edora2-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "edora2",
            storageBucket: "edora2.firebasestorage.app",
            messagingSenderId: "908106047332",
            appId: "1:908106047332:web:4b412cd208e88fceb06471",
            measurementId: "G-ELBKQDSSKC"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        // Backend API configuration
        const PREDICT_LEVEL_API_URL = 'http://127.0.0.1:5000/predict_level';
        const GENERATE_CONTENT_API_URL = 'http://127.0.0.1:5000/generate_chatgpt_content';
        
        // Quiz state
        let currentLevel = "Level 1";
        let currentQuestionIndex = 0;
        let questions = [];
        let score = 0;
        let selectedOption = null;
        let quizCompleted = false;
        let completedLevels = [false, false, false];
        let currentUser = null;
        let isRetaking = false;

        // Initialize the quiz
        document.addEventListener('DOMContentLoaded', () => {
            // Check authentication state
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    document.getElementById('user-name').textContent = user.email;
                    document.getElementById('user-status').textContent = "Authenticated";
                    
                    // Load user progress from Firebase
                    loadUserProgress();
                } else {
                    // Redirect to login if not authenticated
                    document.getElementById('user-status').textContent = "Not authenticated - redirecting to login...";
                    setTimeout(() => {
                        window.location.href = "index.html";
                    }, 2000);
                }
            });
        });

        // Load user progress from Firebase
        function loadUserProgress() {
            if (!currentUser) return;
            
            const userId = currentUser.uid;
            const userRef = db.ref(`students/${userId}`);
            
            userRef.once('value').then(snapshot => {
                const userData = snapshot.val();
                
                if (userData && userData.completedLevels) {
                    completedLevels = userData.completedLevels;
                } else {
                    // Initialize if not exists
                    completedLevels = [false, false, false];
                    userRef.set({ completedLevels });
                }
                
                updateUI();
                document.getElementById('loading-container').style.display = 'none';
            }).catch(error => {
                console.error("Error loading user data:", error);
                document.getElementById('user-status').textContent = "Error loading data: " + error.message;
            });
        }

        // Update UI based on completed levels
        function updateUI() {
            // Update level buttons based on completion status
            const level1Button = document.getElementById('level-1');
            const level2Button = document.getElementById('level-2');
            const level3Button = document.getElementById('level-3');
            
            // Level 1
            if (completedLevels[0]) {
                level1Button.innerHTML = '<i class="fas fa-check"></i> Level 1: Completed';
                level1Button.classList.add('completed');
                level1Button.disabled = false; // Allow retaking completed levels
                level2Button.disabled = false;
                document.getElementById('db-level1').textContent = 'Completed';
                document.getElementById('db-level1').className = 'status completed';
            } else {
                level1Button.innerHTML = '<i class="fas fa-lock-open"></i> Level 1: Beginner';
                level1Button.classList.remove('completed');
                level1Button.disabled = false;
            }
            
            // Level 2
            if (completedLevels[1]) {
                level2Button.innerHTML = '<i class="fas fa-check"></i> Level 2: Completed';
                level2Button.classList.add('completed');
                level2Button.disabled = false; // Allow retaking completed levels
                level3Button.disabled = false;
                document.getElementById('db-level2').textContent = 'Completed';
                document.getElementById('db-level2').className = 'status completed';
            } else if (completedLevels[0]) {
                level2Button.innerHTML = '<i class="fas fa-lock-open"></i> Level 2: Intermediate';
                level2Button.classList.remove('completed');
                level2Button.disabled = false;
            } else {
                level2Button.innerHTML = '<i class="fas fa-lock"></i> Level 2: Intermediate';
                level2Button.classList.remove('completed');
                level2Button.disabled = true;
            }
            
            // Level 3
            if (completedLevels[2]) {
                level3Button.innerHTML = '<i class="fas fa-check"></i> Level 3: Completed';
                level3Button.classList.add('completed');
                level3Button.disabled = false; // Allow retaking completed levels
                document.getElementById('db-level3').textContent = 'Completed';
                document.getElementById('db-level3').className = 'status completed';
            } else if (completedLevels[1]) {
                level3Button.innerHTML = '<i class="fas fa-lock-open"></i> Level 3: Advanced';
                level3Button.classList.remove('completed');
                level3Button.disabled = false;
            } else {
                level3Button.innerHTML = '<i class="fas fa-lock"></i> Level 3: Advanced';
                level3Button.classList.remove('completed');
                level3Button.disabled = true;
            }

            // Update level status indicators
            const level1Status = document.getElementById('level1-status');
            const level2Status = document.getElementById('level2-status');
            const level3Status = document.getElementById('level3-status');
            
            if (completedLevels[0]) {
                level1Status.innerHTML = '<i class="fas fa-check-circle"></i><h4>Level 1</h4><p>Completed</p>';
                level1Status.className = 'completed';
            } else {
                level1Status.innerHTML = '<i class="fas fa-lock"></i><h4>Level 1</h4><p>Locked</p>';
                level1Status.className = '';
            }

            if (completedLevels[1]) {
                level2Status.innerHTML = '<i class="fas fa-check-circle"></i><h4>Level 2</h4><p>Completed</p>';
                level2Status.className = 'completed';
            } else {
                level2Status.innerHTML = '<i class="fas fa-lock"></i><h4>Level 2</h4><p>Locked</p>';
                level2Status.className = '';
            }

            if (completedLevels[2]) {
                level3Status.innerHTML = '<i class="fas fa-check-circle"></i><h4>Level 3</h4><p>Completed</p>';
                level3Status.className = 'completed';
            } else {
                level3Status.innerHTML = '<i class="fas fa-lock"></i><h4>Level 3</h4><p>Locked</p>';
                level3Status.className = '';
            }
        }

        // Fetch questions for a specific level
        async function loadQuestions(level, generateNewContent = false) {
            const levelNum = parseInt(level.split(' ')[1]);
            const index = levelNum - 1;

            // Reset quiz state
            currentLevel = level;
            currentQuestionIndex = 0;
            score = 0;
            quizCompleted = false;
            questions = [];
            isRetaking = generateNewContent;

            // Show loading state
            document.getElementById('loading-container').style.display = 'block';
            document.getElementById('question-container').style.display = 'none';
            document.getElementById('result-container').style.display = 'none';
            document.getElementById('submit-button').style.display = 'block';
            document.getElementById('next-button').style.display = 'none';

            // Update loading text based on action
            document.getElementById('loading-text').textContent = generateNewContent 
                ? "Generating new questions..." 
                : "Loading questions...";

            // Update UI for selected level
            document.querySelectorAll('.level-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`level-${levelNum}`).classList.add('active');
            document.querySelector('.difficulty').textContent = level +
                (level === "Level 1" ? ": Beginner" :
                    level === "Level 2" ? ": Intermediate" : ": Advanced");

            try {
                if (generateNewContent) {
                    // Generate new content by calling backend APIs
                    await generateNewQuestions();
                } else {
                    // Load existing questions from Firebase
                    await loadExistingQuestions();
                }
            } catch (error) {
                console.error("Error loading questions:", error);
                loadSampleQuestions(level);
            }
        }

        // Generate new questions by calling backend APIs
        async function generateNewQuestions() {
            try {
                // Step 1: Get predictions from backend
                const predictResponse = await fetch(PREDICT_LEVEL_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        student_id: currentUser.email
                    })
                });

                if (!predictResponse.ok) {
                    throw new Error(`Failed to get predictions: ${predictResponse.statusText}`);
                }

                const predictData = await predictResponse.json();
                console.log("Prediction response:", predictData);

                // Step 2: Generate new content based on predictions
                const contentResponse = await fetch(GENERATE_CONTENT_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        student_id: currentUser.email,
                        predicted_levels: predictData.predictions
                    })
                });

                if (!contentResponse.ok) {
                    throw new Error(`Failed to generate content: ${contentResponse.statusText}`);
                }

                const contentData = await contentResponse.json();
                console.log("New content generated:", contentData);

                // Step 3: Extract questions from the new content
                const extractedQuestions = extractQuestionsFromContent(contentData.generated_content);
                
                if (extractedQuestions.length > 0) {
                    questions = extractedQuestions;
                    document.getElementById('loading-container').style.display = 'none';
                    document.getElementById('question-container').style.display = 'block';
                    loadQuestion();
                } else {
                    throw new Error('No questions could be extracted from generated content');
                }

            } catch (error) {
                console.error("Error generating new questions:", error);
                // Fall back to loading existing questions
                await loadExistingQuestions();
            }
        }

        // Load existing questions from Firebase
        async function loadExistingQuestions() {
            const userId = currentUser.uid;
            const userRef = db.ref(`students/${userId}`);
            
            userRef.once('value').then(snapshot => {
                const userData = snapshot.val();
                
                if (userData && userData.generated_content) {
                    // Extract questions from generated_content
                    const extractedQuestions = extractQuestionsFromContent(userData.generated_content);
                    
                    if (extractedQuestions.length > 0) {
                        questions = extractedQuestions;
                        document.getElementById('loading-container').style.display = 'none';
                        document.getElementById('question-container').style.display = 'block';
                        loadQuestion();
                    } else {
                        throw new Error('No questions found in generated content');
                    }
                } else {
                    // If no existing content, generate new content
                    generateNewQuestions();
                }
            }).catch(error => {
                console.error("Error loading existing questions:", error);
                loadSampleQuestions(currentLevel);
            });
        }

        // Extract questions from content - UPDATED TO ALIGN WITH DATASET
        function extractQuestionsFromContent(generatedContent) {
            const questions = [];
            
            if (!generatedContent) return questions;

            // Get all topics from generated_content
            const topics = Object.keys(generatedContent);
            
            // Map quiz levels to our app levels
            const levelMapping = {
                "Level 1": 0, // Beginner topics (level 0 in dataset)
                "Level 2": 1, // Intermediate topics (level 1 in dataset)  
                "Level 3": 2  // Advanced topics (level 2 in dataset)
            };
            
            const targetLevel = levelMapping[currentLevel];
            
            console.log(`Extracting questions for ${currentLevel}, looking for topics with level ${targetLevel}`);
            
            // For each topic, extract questions only if it matches the current level
            topics.forEach(topic => {
                const topicData = generatedContent[topic];
                if (topicData.level === targetLevel && topicData.quiz && typeof topicData.quiz === 'string') {
                    console.log(`Found matching topic: ${topic} with level ${topicData.level}`);
                    const topicQuestions = parseQuizString(topicData.quiz);
                    questions.push(...topicQuestions);
                }
            });
            
            console.log(`Extracted ${questions.length} questions for ${currentLevel}`);
            
            // Return questions (limit to 3 per level)
            return questions.slice(0, 3);
        }

        // Parse quiz string from Firebase format - IMPROVED PARSING
        function parseQuizString(quizString) {
            const questions = [];
            
            if (!quizString) return questions;

            try {
                // Split by "Question X:" pattern
                const questionBlocks = quizString.split(/\n\nQuestion \d+:/);
                
                // Handle first question (doesn't start with "Question X:")
                if (quizString.startsWith("Question ")) {
                    // Remove the first "Question X:" prefix for the first block
                    questionBlocks[0] = questionBlocks[0].replace(/^Question \d+:\s*/, '');
                }
                
                questionBlocks.forEach(block => {
                    if (block.trim()) {
                        const question = parseSingleQuestion(block.trim());
                        if (question) {
                            questions.push(question);
                        }
                    }
                });
            } catch (error) {
                console.error("Error parsing quiz string:", error);
            }
            
            return questions;
        }

        // Parse a single question from the quiz string - IMPROVED PARSING
        function parseSingleQuestion(questionBlock) {
            try {
                const lines = questionBlock.split('\n').filter(line => line.trim() !== '');
                
                if (lines.length < 3) return null;
                
                // The first line is the question text
                const questionText = lines[0].trim();
                
                // Find options (lines that start with A), B), C), D))
                const options = [];
                let correctAnswer = null;
                
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    
                    // Check if this is an option line
                    if (line.match(/^[A-D]\)/)) {
                        options.push(line);
                    }
                    // Check if this is the answer line
                    else if (line.includes('Correct Answer:') || line.includes('-[Correct Answer:')) {
                        // Extract the correct answer letter
                        const match = line.match(/Correct Answer:\s*([A-D])/i);
                        if (match) {
                            correctAnswer = match[1].toUpperCase();
                        }
                    }
                }
                
                // If we have a question, options, and correct answer, create the question object
                if (questionText && options.length >= 2 && correctAnswer) {
                    return {
                        question: questionText,
                        options: options,
                        answer: correctAnswer
                    };
                }
            } catch (error) {
                console.error("Error parsing single question:", error);
            }
            
            return null;
        }

        // Load sample questions as fallback (existing function)
        function loadSampleQuestions(level) {
            // Sample questions for each level (existing implementation)
            const sampleQuestions = {
                "Level 1": [
                    {
                        question: "What is a class in Java?",
                        options: ["A) A blueprint for objects", "B) A method", "C) A variable", "D) A package"],
                        answer: "A"
                    },
                    {
                        question: "What is an object?",
                        options: ["A) An instance of a class", "B) A type of variable", "C) A method", "D) A package"],
                        answer: "A"
                    },
                    {
                        question: "What is encapsulation?",
                        options: ["A) Binding data and methods together", "B) Inheriting from a class", "C) Creating multiple methods with same name", "D) Implementing an interface"],
                        answer: "A"
                    }
                ],
                "Level 2": [
                    {
                        question: "What is inheritance in Java?",
                        options: ["A) A mechanism where one class acquires properties of another", "B) A way to hide data", "C) A type of loop", "D) A method of sorting"],
                        answer: "A"
                    },
                    {
                        question: "What is polymorphism?",
                        options: ["A) Ability of an object to take many forms", "B) Storing data securely", "C) Creating objects", "D) Importing packages"],
                        answer: "A"
                    },
                    {
                        question: "What is method overriding?",
                        options: ["A) Providing specific implementation of a method in subclass", "B) Creating multiple methods with same name", "C) Hiding method implementation", "D) Deleting a method"],
                        answer: "A"
                    }
                ],
                "Level 3": [
                    {
                        question: "What is the difference between abstract class and interface?",
                        options: ["A) Abstract class can have implemented methods, interface cannot", "B) Interface can have implemented methods, abstract class cannot", "C) Both are same", "D) Neither can have implemented methods"],
                        answer: "A"
                    },
                    {
                        question: "What is dynamic method dispatch?",
                        options: ["A) Resolving method call at runtime", "B) Compile-time method binding", "C) Method overloading", "D) Static method calling"],
                        answer: "A"
                    },
                    {
                        question: "What is the purpose of 'final' keyword?",
                        options: ["A) To prevent inheritance/method overriding", "B) To allow inheritance", "C) To make variables public", "D) To create abstract methods"],
                        answer: "A"
                    }
                ]
            };

            questions = sampleQuestions[level] || sampleQuestions["Level 1"];
            document.getElementById('loading-container').style.display = 'none';
            document.getElementById('question-container').style.display = 'block';
            loadQuestion();
        }

        // Retake current level
        function retakeLevel() {
            loadQuestions(currentLevel, true); // Force generating new content
        }

        // Load current question into UI (existing function)
        function loadQuestion() {
            if (questions && questions.length > 0) {
                const question = questions[currentQuestionIndex];
                if (!question) {
                    console.error("No question found for the current index.");
                    return;
                }

                document.getElementById('question-text').textContent = question.question;
                document.getElementById('question-number').textContent = currentQuestionIndex + 1;
                document.getElementById('total-questions').textContent = questions.length;

                const optionsContainer = document.getElementById('options-container');
                optionsContainer.innerHTML = '';

                question.options.forEach((option, index) => {
                    const optionElement = document.createElement('div');
                    optionElement.classList.add('option');
                    optionElement.innerHTML = `
                        <input type="radio" name="answer" id="option-${index}" value="${option}">
                        <label for="option-${index}">${option}</label>
                    `;

                    optionElement.addEventListener('click', () => {
                        selectedOption = option;
                        document.querySelectorAll('.option').forEach(opt => {
                            opt.classList.remove('selected');
                        });
                        optionElement.classList.add('selected');
                        document.getElementById(`option-${index}`).checked = true;
                    });

                    optionsContainer.appendChild(optionElement);
                });

                // Reset feedback
                document.getElementById('feedback').style.display = 'none';
                document.getElementById('feedback').className = 'feedback';
                selectedOption = null;
            } else {
                console.error("No questions available.");
                document.getElementById('loading-container').innerHTML = 
                    '<div class="error-message">Failed to load questions. Please try again later.</div>';
            }
        }

        // Check the selected answer (existing function)
        function checkAnswer() {
            if (selectedOption === null) {
                alert('Please select an answer!');
                return;
            }

            const question = questions[currentQuestionIndex];
            const feedback = document.getElementById('feedback');
            feedback.style.display = 'block';

            // Extract the selected option letter (A, B, C, or D)
            const selectedLetter = selectedOption.charAt(0);
            
            // Compare with the correct answer
            if (selectedLetter === question.answer) {
                feedback.textContent = "Correct! " + getPositiveFeedback();
                feedback.className = 'feedback correct';
                score++;
            } else {
                feedback.textContent = `Incorrect. The correct answer is: ${question.answer}) ${getOptionText(question.options, question.answer)}`;
                feedback.className = 'feedback incorrect';
            }

            // Highlight correct and incorrect answers
            document.querySelectorAll('.option').forEach(option => {
                const optionText = option.querySelector('label').textContent;
                const optionLetter = optionText.charAt(0);
                
                if (optionLetter === question.answer) {
                    option.classList.add('correct');
                } else if (optionLetter === selectedLetter) {
                    option.classList.add('incorrect');
                }
            });

            // Show next button
            document.getElementById('submit-button').style.display = 'none';
            document.getElementById('next-button').style.display = 'block';
        }

        // Get the full text of an option by letter (existing function)
        function getOptionText(options, letter) {
            const option = options.find(opt => opt.charAt(0) === letter);
            return option ? option.substring(3) : '';
        }

        // Load next question or complete quiz (existing function)
        function loadNextQuestion() {
            currentQuestionIndex++;

            if (currentQuestionIndex < questions.length) {
                selectedOption = null;
                loadQuestion();
                document.getElementById('submit-button').style.display = 'block';
                document.getElementById('next-button').style.display = 'none';
            } else {
                completeQuiz();
            }
        }

        // Complete the quiz and show results (existing function)
        function completeQuiz() {
            quizCompleted = true;
            const percentage = Math.round((score / questions.length) * 100);

            document.getElementById('question-container').style.display = 'none';
            document.getElementById('result-container').style.display = 'block';
            document.getElementById('final-score').textContent = `${percentage}%`;
            document.getElementById('progress-bar').style.width = `${percentage}%`;

            if (percentage >= 80) {
                document.getElementById('result-message').textContent = 
                    "Excellent! You've mastered this level!";
                // Always unlock the current level if score is >= 80%
                markLevelCompleted();
            } else if (percentage >= 60) {
                document.getElementById('result-message').textContent = 
                    "Good job! Review the material and try again!";
            } else {
                document.getElementById('result-message').textContent = 
                    "Keep studying! You'll do better next time!";
            }
        }

        // Mark the current level as completed in Firebase
        function markLevelCompleted() {
            const currentLevelNum = parseInt(currentLevel.split(' ')[1]);
            const index = currentLevelNum - 1;
            
            // Only mark as completed if not already completed (to avoid overwriting)
            if (!completedLevels[index]) {
                setLevelCompleted(index);
            }
        }

        // Set level as completed in Firebase (existing function)
        function setLevelCompleted(levelIndex) {
            if (!currentUser) return;
            
            completedLevels[levelIndex] = true;
            const userId = currentUser.uid;
            const userRef = db.ref(`students/${userId}`);
            
            userRef.update({ completedLevels })
                .then(() => {
                    console.log(`Level ${levelIndex + 1} marked as completed`);
                    updateUI();
                })
                .catch(error => {
                    console.error("Error updating level completion:", error);
                });
        }

        // Generate positive feedback messages (existing function)
        function getPositiveFeedback() {
            const feedbacks = [
                "Great job! You really understand this concept.",
                "Excellent! Your knowledge is impressive.",
                "Well done! You're mastering Java OOP.",
                "Perfect! You clearly understand this topic.",
                "Awesome! Your answer was spot on.",
                "Brilliant! You're becoming an OOP expert."
            ];
            return feedbacks[Math.floor(Math.random() * feedbacks.length)];
        }
    </script>
</body>
</html>