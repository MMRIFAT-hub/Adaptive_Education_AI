<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Faculty Dashboard</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* General Styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background: linear-gradient(135deg, #1a2a6c, #000000, #1a2a6c);
      color: #fff;
      min-height: 100vh;
      line-height: 1.6;
    }

    /* Header Styles */
    header {
      background: rgba(0, 0, 0, 0.3);
      padding: 20px 0;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(5px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .nav-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 40px;
    }

    .logo a {
      background-image: url('../img/logo2.png');
    background-size: contain;
    background-repeat: no-repeat;
    height: 170px;
    width: 170px;
    display: inline-block;
    text-indent: -9999px;
    position: relative;
    border-radius: 50px;
    }

    .logo-icon {
      color: #3498db;
      font-size: 28px;
    }

    .glow-title {
      font-size: 30px;
      font-weight: bold;
      text-transform: uppercase;
      text-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
      background: linear-gradient(to right, #d2cbcb, #e4e0f0);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    /* Container */
    .container {
      max-width: 1400px;
      margin: 30px auto;
      padding: 0 20px;
    }

    /* Analytics Grid */
    .analytics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 25px;
      margin-bottom: 30px;
    }
    
    .analytics-card {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .analytics-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
    }
    
    .analytics-card h3 {
      margin-top: 0;
      color: #3498db;
      font-size: 1.2em;
      border-bottom: 2px solid rgba(255, 255, 255, 0.1);
      padding-bottom: 15px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .card-icon {
      font-size: 1.5rem;
    }
    
    .stat-value {
      font-size: 2.5em;
      font-weight: bold;
      color: #2ecc71;
      margin: 10px 0;
      text-shadow: 0 0 10px rgba(46, 204, 113, 0.3);
    }
    
    .stat-label {
      color: #b0b0b0;
      font-size: 0.9em;
      margin-bottom: 15px;
    }
    
    .progress-container {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      height: 12px;
      margin: 15px 0;
      overflow: hidden;
    }
    
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #3498db, #2ecc71);
      border-radius: 10px;
      transition: width 0.5s ease;
    }
    
    /* Topic Breakdown */
    .topic-breakdown {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 15px;
    }
    
    .topic-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      transition: all 0.3s ease;
    }

    .topic-item:hover {
      background: rgba(52, 152, 219, 0.1);
      transform: translateX(5px);
    }
    
    .topic-score {
      font-weight: bold;
      color: #f39c12;
      font-size: 1.1em;
    }

    .topic-progress {
      flex: 1;
      margin: 0 15px;
      height: 8px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      overflow: hidden;
    }

    .topic-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #9b59b6, #e74c3c);
      border-radius: 4px;
    }
    
    /* Level Distribution */
    .level-distribution {
      display: flex;
      justify-content: space-between;
      margin-top: 15px;
    }
    
    .level-item {
      text-align: center;
      flex: 1;
      padding: 10px;
    }
    
    .level-count {
      font-size: 1.8em;
      font-weight: bold;
      color: #3498db;
      margin-bottom: 5px;
    }
    
    .level-label {
      font-size: 0.8em;
      color: #b0b0b0;
    }

    .level-progress {
      height: 8px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      margin-top: 8px;
      overflow: hidden;
    }

    .level-progress-bar {
      height: 100%;
      border-radius: 4px;
    }
    
    /* Risk Indicators */
    .risk-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 8px;
    }
    
    .risk-high { background: #e74c3c; }
    .risk-medium { background: #f39c12; }
    .risk-low { background: #2ecc71; }
    
    /* Student Lists */
    .student-list {
      max-height: 200px;
      overflow-y: auto;
      margin-top: 10px;
    }
    
    .student-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      transition: background 0.3s ease;
    }

    .student-item:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    /* Performance Table */
    .performance-data {
      margin-top: 30px;
    }

    .summary-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .card {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      text-align: center;
    }
    
    .card h4 {
      color: #b0b0b0;
      margin-bottom: 15px;
      font-size: 1.1em;
    }
    
    .highlight {
      font-size: 2.2em;
      font-weight: bold;
      color: #3498db;
      text-shadow: 0 0 10px rgba(52, 152, 219, 0.3);
    }
    
    .performance-table {
      width: 100%;
      border-collapse: collapse;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(10px);
    }
    
    .performance-table th {
      background: rgba(0, 0, 0, 0.3);
      padding: 15px;
      text-align: left;
      color: #3498db;
      font-weight: 600;
    }
    
    .performance-table td {
      padding: 15px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .performance-table tr:last-child td {
      border-bottom: none;
    }
    
    .performance-table tr:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    /* Sidebar Styles */
    .sidebar-toggle {
      position: fixed;
      top: 20px;
      left: 20px;
      background: rgba(52, 152, 219, 0.8);
      color: white;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      font-size: 20px;
      cursor: pointer;
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .sidebar-toggle:hover {
      background: rgba(41, 128, 185, 0.9);
      transform: scale(1.1);
    }

    .sidebar {
      position: fixed;
      top: 0;
      left: -300px;
      width: 300px;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(10px);
      transition: left 0.3s ease;
      z-index: 999;
      padding: 80px 20px 20px;
      overflow-y: auto;
    }

    .sidebar.active {
      left: 0;
    }

    .sidebar ul {
      list-style: none;
    }

    .sidebar li {
      margin-bottom: 10px;
    }

    .sidebar a {
      display: block;
      color: white;
      text-decoration: none;
      padding: 15px;
      border-radius: 8px;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .sidebar a:hover {
      background: rgba(52, 152, 219, 0.3);
      transform: translateX(5px);
    }

    .sidebar a i {
      width: 20px;
      text-align: center;
    }

    /* Footer */
    .footer {
      text-align: center;
      padding: 30px;
      margin-top: 50px;
      color: rgba(255, 255, 255, 0.7);
    }

    /* Buttons */
    .logout-button {
      position: fixed;
      bottom: 30px;
      right: 30px;
      padding: 12px 25px;
      background: linear-gradient(45deg, #e74c3c, #c0392b);
      color: white;
      border: none;
      border-radius: 50px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      display: flex;
      align-items: center;
      gap: 8px;
      z-index: 100;
    }

    .logout-button:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
    }

    .learn-more {
      position: fixed;
      bottom: 30px;
      left: 30px;
      padding: 12px 25px;
      background: linear-gradient(45deg, #3498db, #2980b9);
      color: white;
      border: none;
      border-radius: 50px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }

    .learn-more:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
    }

    /* Responsive */
    @media screen and (max-width: 768px) {
      .analytics-grid {
        grid-template-columns: 1fr;
      }
      
      .summary-cards {
        grid-template-columns: 1fr;
      }
      
      .level-distribution {
        flex-direction: column;
        gap: 15px;
      }
      
      .nav-bar {
        padding: 0 20px;
        flex-direction: column;
        gap: 15px;
      }
      
      .glow-title {
        font-size: 24px;
      }
      
      .sidebar {
        width: 250px;
        left: -250px;
      }
    }
  </style>
</head>
<body>

  <header>
    <nav>
      <ul class="nav-bar">
        <li class="logo"><a href="teacherDashboard.html"><i class="fas fa-graduation-cap logo-icon"></i> EDGo</a></li>
        <div class="center-links">
          <h1 class="glow-title">Faculty Dashboard - Enhanced Analytics</h1>
        </div>
      </ul>
    </nav>
  </header>

  <!-- Sidebar Toggle Button -->
  <button id="toggle-sidebar" class="sidebar-toggle">
    <i class="fas fa-bars"></i>
  </button>

  <!-- Sidebar -->
  <div id="sidebar" class="sidebar">
    <ul>
      <li><a href="#"><i class="fas fa-chart-line"></i> Student Performance</a></li>
      <li><a href="retakeFaculty.html"><i class="fas fa-redo"></i> Retake Request</a></li>
      <li><a href="addStudent.html"><i class="fas fa-user-plus"></i> Add Student</a></li>
      <li><a href="grading.html"><i class="fas fa-check-circle"></i> Grading Students</a></li>
      <li><a href="#"><i class="fas fa-robot"></i> AI Assessment</a></li>
      <li><a href="#"><i class="fas fa-cog"></i> Settings</a></li>
    </ul>
  </div>

  <div class="container">
    <!-- New Analytics Section -->
    <div class="analytics-grid" id="analytics-grid">
      <!-- Analytics will be populated by JavaScript -->
    </div>

    <section class="performance-data">
      <div class="summary-cards">
        <div class="card">
          <h4>Average Midterm Score</h4>
          <p><span class="highlight" id="average-score">Loading...</span></p>
        </div>
        <div class="card">
          <h4>Total Retakes Remaining</h4>
          <p><span class="highlight">9</span></p>
        </div>
        <div class="card">
          <h4>Total Students</h4>
          <p><span class="highlight" id="total-students">0</span></p>
        </div>
        <div class="card">
          <h4>Class Average</h4>
          <p><span class="highlight" id="class-average">0%</span></p>
        </div>
      </div>

      <table class="performance-table">
        <thead>
          <tr>
            <th>Student ID</th>
            <th>Name</th>
            <th>Midterm Score</th>
            <th>Percentage</th>
            <th>Current Level</th>
            <th>Retake Date</th>
          </tr>
        </thead>
        <tbody>
          <!-- Dynamic rows will be inserted here from Firebase -->
        </tbody>
      </table>
    </section>
  </div>

  <div class="footer">
    <p>EDGo Faculty Dashboard &copy; 2023 | Dhaka, Bangladesh</p>
  </div>

  <!-- Replace your current logout button with this -->
<button id="logout-button" class="logout-button" onclick="handleQuickLogout()">
    <i class="fas fa-sign-out-alt"></i> Logout
</button>

<script>
// Quick logout function - add this at the very bottom of your file
function handleQuickLogout() {
    // This will redirect to index.html immediately
    window.location.href = "index.html";
    
    // If you want to actually sign out from Firebase, you'll need to 
    // implement a proper Firebase auth signout on your index.html page
    // or use the consolidated solution above
}
</script>

  <!-- Use "type=module" to use ES modules (import/export) -->
  <script type="module">
    // Import necessary Firebase functions
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";

    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyD63qm0V0F0Y0PExzmmOCP9nJ7a6x1vCgs",
      authDomain: "edora2.firebaseapp.com",
      projectId: "edora2",
      storageBucket: "edora2.firebasestorage.app",
      messagingSenderId: "908106047332",
      appId: "1:908106047332:web:4b412cd208e88fceb06471",
      measurementId: "G-ELBKQDSSKC",
      databaseURL: "https://edora2-default-rtdb.asia-southeast1.firebasedatabase.app"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    const auth = getAuth();

    // Enhanced analytics functions
    function calculateAnalytics(students) {
      const analytics = {
        totalStudents: 0,
        averageMidtermScore: 0,
        averageOverallPercentage: 0,
        levelCompletion: { level1: 0, level2: 0, level3: 0 },
        topicPerformance: {},
        atRiskStudents: [],
        topPerformers: [],
        retakeEligibility: 0
      };

      let totalMidtermScore = 0;
      let totalOverallPercentage = 0;
      let studentCount = 0;

      for (const studentId in students) {
        const student = students[studentId];
        studentCount++;

        // Fix for NaN and Infinity in midterm scores
        const midtermScore = student.midtermScore || 0;
        const totalScore = student.totalScore || 1; // Avoid division by zero
        const percentage = student.percentage || (midtermScore / totalScore) * 100;
        
        // Midterm score
        totalMidtermScore += midtermScore;
        
        // Overall percentage - ensure it's a valid number
        totalOverallPercentage += isNaN(percentage) || !isFinite(percentage) ? 0 : Math.min(percentage, 100);

        // Level completion
        if (student.completedLevels) {
          if (student.completedLevels[0]) analytics.levelCompletion.level1++;
          if (student.completedLevels[1]) analytics.levelCompletion.level2++;
          if (student.completedLevels[2]) analytics.levelCompletion.level3++;
        }

        // Topic performance - FIXED: Cap percentages at 100 and ensure valid data
        if (student.topic_scores) {
          for (const topic in student.topic_scores) {
            if (!analytics.topicPerformance[topic]) {
              analytics.topicPerformance[topic] = {
                total: 0,
                count: 0,
                average: 0
              };
            }
            // Cap topic scores at 100% to prevent unrealistic values
            let topicScore = student.topic_scores[topic];
            
            // Fix for incorrect topic score values (like 500%, 1000%, etc.)
            if (topicScore > 100) {
              // If the score is way too high, it might be stored incorrectly
              // Try to normalize it
              topicScore = Math.min(topicScore / 10, 100);
            }
            
            topicScore = Math.min(topicScore, 100);
            analytics.topicPerformance[topic].total += topicScore;
            analytics.topicPerformance[topic].count++;
          }
        }

        // Identify at-risk students (midterm score < 40 or overall percentage < 50)
        if ((midtermScore < 40 || percentage < 50) && student.name) {
          analytics.atRiskStudents.push({
            name: student.name,
            midtermScore: midtermScore,
            percentage: percentage,
            riskLevel: midtermScore < 30 || percentage < 30 ? 'high' : 
                      midtermScore < 40 || percentage < 40 ? 'medium' : 'low'
          });
        }

        // Identify top performers (overall percentage > 80)
        if (percentage > 80 && student.name) {
          analytics.topPerformers.push({
            name: student.name,
            percentage: percentage,
            completedLevels: student.completedLevels ? student.completedLevels.filter(Boolean).length : 0
          });
        }

        // Retake eligibility
        if (student.retakeDaysLeft > 0) {
          analytics.retakeEligibility++;
        }
      }

      // Calculate averages
      analytics.totalStudents = studentCount;
      analytics.averageMidtermScore = studentCount > 0 ? totalMidtermScore / studentCount : 0;
      analytics.averageOverallPercentage = studentCount > 0 ? totalOverallPercentage / studentCount : 0;

      // Calculate topic averages - FIXED: Ensure we don't divide by zero
      for (const topic in analytics.topicPerformance) {
        const topicData = analytics.topicPerformance[topic];
        topicData.average = topicData.count > 0 ? topicData.total / topicData.count : 0;
      }

      // Sort at-risk students by risk level
      analytics.atRiskStudents.sort((a, b) => {
        const riskOrder = { high: 0, medium: 1, low: 2 };
        return riskOrder[a.riskLevel] - riskOrder[b.riskLevel];
      });

      // Sort top performers by percentage
      analytics.topPerformers.sort((a, b) => b.percentage - a.percentage);

      return analytics;
    }

    function renderAnalytics(analytics) {
      const analyticsGrid = document.getElementById('analytics-grid');
      
      // Format topic names for display
      const formatTopicName = (topic) => {
        return topic.replace('_label', '').replace(/([A-Z])/g, ' $1').trim();
      };
      
      analyticsGrid.innerHTML = `
        <!-- Overall Performance Card -->
        <div class="analytics-card">
          <h3><i class="fas fa-chart-line card-icon"></i> Overall Class Performance</h3>
          <div class="stat-value">${analytics.averageOverallPercentage.toFixed(1)}%</div>
          <div class="stat-label">Average Overall Score</div>
          <div class="progress-container">
            <div class="progress-bar" style="width: ${analytics.averageOverallPercentage}%"></div>
          </div>
          <div style="display: flex; justify-content: space-between; margin-top: 15px;">
            <div>
              <div style="font-size: 1.5em; font-weight: bold; color: #3498db;">${analytics.averageMidtermScore.toFixed(1)}</div>
              <div class="stat-label">Avg Midterm</div>
            </div>
            <div>
              <div style="font-size: 1.5em; font-weight: bold; color: #2ecc71;">${analytics.totalStudents}</div>
              <div class="stat-label">Total Students</div>
            </div>
          </div>
        </div>

        <!-- Level Completion Card -->
        <div class="analytics-card">
          <h3><i class="fas fa-layer-group card-icon"></i> Level Completion Progress</h3>
          <div class="level-distribution">
            <div class="level-item">
              <div class="level-count">${analytics.levelCompletion.level1}</div>
              <div class="level-label">Level 1</div>
              <div class="level-progress">
                <div class="level-progress-bar" style="width: ${(analytics.levelCompletion.level1 / analytics.totalStudents) * 100}%; background: #3498db;"></div>
              </div>
            </div>
            <div class="level-item">
              <div class="level-count">${analytics.levelCompletion.level2}</div>
              <div class="level-label">Level 2</div>
              <div class="level-progress">
                <div class="level-progress-bar" style="width: ${(analytics.levelCompletion.level2 / analytics.totalStudents) * 100}%; background: #9b59b6;"></div>
              </div>
            </div>
            <div class="level-item">
              <div class="level-count">${analytics.levelCompletion.level3}</div>
              <div class="level-label">Level 3</div>
              <div class="level-progress">
                <div class="level-progress-bar" style="width: ${(analytics.levelCompletion.level3 / analytics.totalStudents) * 100}%; background: #2ecc71;"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Topic Performance Card -->
        <div class="analytics-card">
          <h3><i class="fas fa-brain card-icon"></i> Topic Performance Analysis</h3>
          <div class="topic-breakdown">
            ${Object.entries(analytics.topicPerformance).map(([topic, data]) => {
              // Format topic names nicely
              const topicName = formatTopicName(topic);
              // Ensure average is between 0-100
              const displayAverage = Math.min(Math.max(data.average, 0), 100);
              return `
                <div class="topic-item">
                  <span>${topicName}</span>
                  <div class="topic-progress">
                    <div class="topic-progress-bar" style="width: ${displayAverage}%"></div>
                  </div>
                  <span class="topic-score">${displayAverage.toFixed(0)}%</span>
                </div>
              `;
            }).join('')}
          </div>
        </div>

        <!-- At-Risk Students Card -->
        <div class="analytics-card">
          <h3><i class="fas fa-exclamation-triangle card-icon"></i> Students Needing Attention</h3>
          <div class="stat-value">${analytics.atRiskStudents.length}</div>
          <div class="stat-label">At-Risk Students</div>
          <div class="student-list">
            ${analytics.atRiskStudents.slice(0, 5).map(student => `
              <div class="student-item">
                <span>
                  <span class="risk-indicator risk-${student.riskLevel}"></span>
                  ${student.name}
                </span>
                <span>${student.midtermScore}/${student.percentage.toFixed(1)}%</span>
              </div>
            `).join('')}
            ${analytics.atRiskStudents.length > 5 ? `<div style="text-align: center; color: #b0b0b0; margin-top: 10px; padding: 10px;">+${analytics.atRiskStudents.length - 5} more students</div>` : ''}
          </div>
        </div>

        <!-- Top Performers Card -->
        <div class="analytics-card">
          <h3><i class="fas fa-trophy card-icon"></i> Top Performers</h3>
          <div class="student-list">
            ${analytics.topPerformers.slice(0, 5).map(student => `
              <div class="student-item">
                <span>${student.name}</span>
                <span style="color: #2ecc71; font-weight: bold;">${student.percentage.toFixed(1)}%</span>
              </div>
            `).join('')}
          </div>
        </div>

        <!-- Retake Analytics Card -->
        <div class="analytics-card">
          <h3><i class="fas fa-redo card-icon"></i> Retake Management</h3>
          <div class="stat-value">${analytics.retakeEligibility}</div>
          <div class="stat-label">Eligible for Retake</div>
          <div style="margin-top: 15px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px; padding: 8px; background: rgba(0,0,0,0.2); border-radius: 5px;">
              <span>Available Retakes:</span>
              <span style="font-weight: bold; color: #2ecc71;">9</span>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 8px; background: rgba(0,0,0,0.2); border-radius: 5px;">
              <span>Utilized:</span>
              <span style="font-weight: bold; color: #3498db;">${analytics.totalStudents - analytics.retakeEligibility}</span>
            </div>
          </div>
        </div>
      `;
    }

    // Fetch student data from Firebase Realtime Database
    window.onload = function() {
      onAuthStateChanged(auth, function(user) {
        if (user) {
          const teacherId = user.uid; // Get the teacher's UID
          
          const studentsRef = ref(database, `teachers/${teacherId}/students`);
          get(studentsRef)
            .then((snapshot) => {
              if (snapshot.exists()) {
                const students = snapshot.val();
                const tableBody = document.querySelector('.performance-table tbody');
                const averageScoreElement = document.getElementById('average-score');
                const totalStudentsElement = document.getElementById('total-students');
                const classAverageElement = document.getElementById('class-average');
                
                let totalPercentage = 0;
                let studentCount = 0;
                let totalMidtermScore = 0;

                tableBody.innerHTML = ''; // Clear previous rows

                for (const studentId in students) {
                  const student = students[studentId];

                  // Fix for NaN and Infinity in percentage calculations
                  const midtermScore = student.midtermScore || 0;
                  const totalScore = student.totalScore || 1; // Avoid division by zero
                  let percentage = student.percentage || (midtermScore / totalScore) * 100;
                  
                  // Ensure percentage is a valid number between 0 and 100
                  if (isNaN(percentage) || !isFinite(percentage)) {
                    percentage = 0;
                  } else {
                    percentage = Math.min(percentage, 100); // Cap at 100%
                  }
                  
                  totalPercentage += percentage;
                  totalMidtermScore += midtermScore;
                  studentCount++;

                  const tr = document.createElement('tr');
                  tr.innerHTML = `
                    <td>${studentId}</td>
                    <td>${student.name || 'Unknown'}</td>
                    <td>${midtermScore}/${totalScore}</td>
                    <td>${percentage.toFixed(2)}%</td>
                    <td>Completed ${student.completedLevels ? student.completedLevels.filter(level => level === true).length : 0} out of 3 Levels</td>
                    <td>${student.retakeDate ? new Date(student.retakeDate).toLocaleDateString() : 'N/A'}</td>
                  `;
                  tableBody.appendChild(tr);
                }

                // Calculate and display the average percentage
                if (studentCount > 0) {
                  const averagePercentage = totalPercentage / studentCount;
                  const averageMidtermScore = totalMidtermScore / studentCount;
                  
                  averageScoreElement.textContent = `${averageMidtermScore.toFixed(2)}`;
                  totalStudentsElement.textContent = studentCount;
                  classAverageElement.textContent = `${averagePercentage.toFixed(2)}%`;
                  
                  // Calculate and render enhanced analytics
                  const analytics = calculateAnalytics(students);
                  renderAnalytics(analytics);
                } else {
                  averageScoreElement.textContent = 'No students available';
                  totalStudentsElement.textContent = '0';
                  classAverageElement.textContent = '0%';
                }

              } else {
                console.log("No data available");
                document.getElementById('average-score').textContent = 'No data available';
                document.getElementById('total-students').textContent = '0';
                document.getElementById('class-average').textContent = '0%';
              }
            })
            .catch((error) => {
              console.error("Error fetching data from Firebase:", error);
              document.getElementById('average-score').textContent = 'Error fetching data';
              document.getElementById('total-students').textContent = '0';
              document.getElementById('class-average').textContent = '0%';
            });
        } else {
          // If no user is logged in, redirect to login
          window.location.href = 'login.html';
        }
      });
    };
  </script>

  <script>
    // Toggle sidebar functionality
    document.getElementById('toggle-sidebar').addEventListener('click', () => {
      const sidebar = document.getElementById('sidebar');
      sidebar.classList.toggle('active');
    });

    // Logout functionality
    const logoutButton = document.getElementById("logout-button");
    logoutButton.addEventListener("click", () => {
      signOut(auth)
        .then(() => {
          window.location.href = "index.html"; // Redirect to login page after logout
        })
        .catch((error) => {
          console.error("Error signing out: ", error);
        });
    });
  </script>

</body>
</html>